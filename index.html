<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de Unidades</title>
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50; --secondary-color: #3498db; --accent-color: #e74c3c;
            --light-color: #ecf0f1; --dark-color: #2c3e50; --success-color: #2ecc71;
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            background-color: #f5f7fa; color: var(--dark-color);
            line-height: 1.6; font-family: var(--font-family); padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 20px auto; background-color: white;
            border-radius: 12px; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1); overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 40px 25px; text-align: center;
        }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .notation-note { font-size: 0.9rem; background-color: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px; display: inline-block; }
        .converter { padding: 30px; }
        
        .selectors-group {
            display: flex; flex-wrap: wrap; gap: 20px;
            align-items: flex-end; margin-bottom: 10px;
        }
        .input-field { flex: 1; min-width: 180px; }
        .unit-swap-container { display: flex; align-items: flex-end; gap: 10px; flex: 2; min-width: 380px; }
        .value-field { flex: 1.5; min-width: 200px; }
        
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color); font-size: 0.95rem; }
        select, input[type="text"] {
            width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem;
            transition: border-color 0.3s, box-shadow 0.3s; background-color: #fff; appearance: none;
        }
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 1em; padding-right: 40px; cursor: pointer;
        }
        select:focus, input:focus {
            outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
        }
        #swapBtn {
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; line-height: 1; background-color: var(--light-color);
            border: 2px solid #ddd; border-radius: 50%; cursor: pointer; transition: background-color 0.3s, transform 0.3s;
            flex-shrink: 0; width: 50px; height: 50px;
        }
        #swapBtn:hover { background-color: #e0e0e0; transform: rotate(180deg); }
        
        .hint-container {
            text-align: right; padding-right: 5px; margin-bottom: 30px;
        }
        .input-hint { font-size: 0.85rem; color: #666; }

        .convert-button-container { text-align: center; margin-bottom: 30px; }
        button#convertBtn {
            background-color: var(--secondary-color); color: white; border: none; padding: 14px 45px; border-radius: 8px; cursor: pointer;
            font-size: 1.25rem; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button#convertBtn:hover { background-color: #2980b9; transform: translateY(-3px); box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3); }
        .result-container { margin-top: 20px; padding: 25px; background-color: #f8f9fa; border-radius: 8px; display: none; }
        
        /* --- ÚNICO CAMBIO: Color del resultado a negro/oscuro para mejor legibilidad --- */
        .result-value {
            font-size: 1.25rem; font-weight: 700;
            color: var(--primary-color); /* Cambiado de --success-color a --primary-color */
            text-align: center; margin-bottom: 25px; word-wrap: break-word;
        }
        
        .toggle-steps-container { text-align: center; margin-bottom: 20px; }
        .secondary-button {
            background-color: transparent; color: var(--primary-color); border: 2px solid #ddd;
            padding: 10px 25px; border-radius: 8px; cursor: pointer; font-size: 1rem;
            font-weight: 600; transition: all 0.3s ease;
        }
        .secondary-button:hover { background-color: #f0f0f0; border-color: #ccc; }
        
        .steps { display: none; margin-top: 25px; background-color: white; padding: 20px; border-radius: 8px; border-left: 5px solid var(--secondary-color); }
        .steps h4 { margin-bottom: 15px; font-size: 1.2rem; color: var(--primary-color); }
        .step { margin-bottom: 15px; padding: 12px; background-color: #f8f9fa; border-radius: 5px; display: flex; align-items: center; font-size: 1.05rem; }
        .step:last-child { margin-bottom: 0; }
        .step-number {
            display: inline-flex; align-items: center; justify-content: center; background-color: var(--secondary-color); color: white;
            min-width: 28px; height: 28px; border-radius: 50%; margin-right: 12px; font-weight: bold; flex-shrink: 0;
        }
        .error-message {
            display: flex; align-items: center; background-color: #f8d7da; color: #721c24; padding: 15px;
            border-radius: 8px; margin-top: 20px; border-left: 5px solid var(--accent-color); font-weight: 500;
        }
        .history-section { margin-top: 40px; padding: 25px; background-color: #f8f9fa; border-radius: 8px; display: none; }
        .history-section h3 { margin-bottom: 15px; }
        .history-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        .history-item-date { color: #777; font-size: 0.85rem; }
        .clear-history {
            background-color: var(--accent-color); color: white; border: none; padding: 8px 15px; border-radius: 5px;
            cursor: pointer; margin-top: 15px; font-size: 0.9rem; float: right; transition: background-color 0.2s;
        }
        .clear-history:hover { background-color: #c0392b; }
        .theory-section { margin-top: 40px; padding: 25px; background-color: #f0f7ff; border-radius: 8px; }
        .theory-section h2 { margin-bottom: 20px; text-align: center; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; flex-wrap: wrap; gap: 5px; }
        .tab {
            padding: 10px 18px; cursor: pointer; background-color: transparent; border: none; border-bottom: 3px solid transparent;
            font-weight: 600; color: #555; transition: all 0.3s;
        }
        .tab.active { color: var(--secondary-color); border-bottom-color: var(--secondary-color); }
        .theory-content { display: none; }
        .theory-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .theory-item { margin-bottom: 20px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .formula { text-align: center; margin: 10px 0; font-size: 1.1rem; }
        footer { text-align: center; padding: 25px; background-color: var(--light-color); color: var(--dark-color); font-size: 0.9rem; margin-top: 20px; }
        footer a { color: var(--secondary-color); text-decoration: none; font-weight: 600; }
        footer a:hover { text-decoration: underline; }
        
        @media (max-width: 992px) {
            .selectors-group { flex-direction: column; align-items: stretch; gap: 15px; }
            .unit-swap-container { flex-direction: row; }
            .hint-container { text-align: center; margin-top: -15px; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; } .container { margin: 10px auto; } h1 { font-size: 2rem; }
            .converter, .history-section, .theory-section { padding: 20px; }
            .unit-swap-container { flex-direction: column; align-items: stretch; gap: 15px; }
            .unit-swap-container { min-width: 100%; } #swapBtn { transform: rotate(90deg); margin: 0 auto; }
            #swapBtn:hover { transform: rotate(270deg); }
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; } button#convertBtn { width: 100%; }
            .result-value { font-size: 1.1rem; } .tab { padding: 8px 10px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Conversor de Unidades</h1>
            <div class="notation-note">Nota: Usamos notación anglosajona (punto decimal) para los cálculos.</div>
        </header>
        
        <main class="converter">
            <div class="selectors-group">
                <div class="input-field">
                    <label for="category">Categoría de Magnitud</label>
                    <select id="category">
                        <option value="longitud">Longitud</option> <option value="area">Área</option> <option value="volumen">Volumen</option>
                        <option value="masa">Masa</option> <option value="tiempo">Tiempo</option> <option value="velocidad">Velocidad</option>
                        <option value="aceleracion">Aceleración</option> <option value="fuerza">Fuerza</option> <option value="presion">Presión</option>
                        <option value="densidad">Densidad</option> <option value="pesoEspecifico">Peso Específico</option> <option value="energia">Energía</option>
                        <option value="temperatura">Temperatura</option> <option value="potencia">Potencia</option>
                    </select>
                </div>
                <div class="unit-swap-container">
                    <div class="input-field"><label for="fromUnit">Unidad de Origen</label><select id="fromUnit"></select></div>
                    <button id="swapBtn" title="Intercambiar unidades" aria-label="Intercambiar unidades de origen y destino">⇄</button>
                    <div class="input-field"><label for="toUnit">Unidad de Destino</label><select id="toUnit"></select></div>
                </div>
                <div class="input-field value-field">
                    <label for="value">Valor a Convertir</label>
                    <input type="text" id="value" placeholder="1.0" inputmode="decimal">
                </div>
            </div>
            
            <div class="hint-container">
                <div class="input-hint" id="valueHint">Usa punto para decimales. Ej: 1.5e-3</div>
            </div>
            
            <div class="convert-button-container"><button id="convertBtn">Convertir</button></div>
            
            <div id="error-container"></div>
            <div id="live-region" aria-live="polite" aria-atomic="true" style="position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;"></div>
            
            <div class="result-container" id="resultContainer" role="status">
                <div class="result-value" id="resultValue"></div>
                <div class="toggle-steps-container" id="toggleStepsContainer" style="display: none;">
                    <button id="toggleStepsBtn" class="secondary-button">Mostrar Pasos de la Conversión</button>
                </div>
                <div class="steps" id="steps"></div>
            </div>

            <div class="history-section" id="historySection" role="region" aria-labelledby="history-title">
                <h3 id="history-title">Historial de Conversiones</h3>
                <div id="historyList"></div>
                <button class="clear-history" id="clearHistory">Limpiar Historial</button>
            </div>
            <div class="theory-section" role="region" aria-labelledby="theory-title">
                <h2 id="theory-title">Definiciones y Fórmulas Clave</h2>
                <div class="tabs">
                    <button class="tab active" data-tab="newton">Newton (Fuerza)</button>
                    <button class="tab" data-tab="pascal">Pascal (Presión)</button>
                    <button class="tab" data-tab="joule">Joule (Energía)</button>
                    <button class="tab" data-tab="densidad">Densidad</button>
                    <button class="tab" data-tab="volumen-capacidad">Volumen y Capacidad</button>
                    <button class="tab" data-tab="peso-especifico">Peso Específico</button>
                </div>
                <div class="theory-content active" id="newton-content"><div class="theory-item"><h3>Newton (N)</h3><p>El newton es la unidad de fuerza en el SI. Se define como la fuerza necesaria para proporcionar una aceleración de \(1 \, \text{m/s}^2\) a un objeto de \(1 \, \text{kg}\) de masa.</p><div class="formula">\[ F = m \cdot a \quad \rightarrow \quad 1 \, \text{N} = 1 \, \text{kg} \cdot \frac{\text{m}}{\text{s}^2} \]</div><p><strong>Nota:</strong> En la Tierra, la aceleración de la gravedad estándar es \(g = 9.80665 \, \text{m/s}^2\). Por lo tanto, el peso de un objeto de masa \(m\) es:</p><div class="formula">\[ P = m \cdot g \]</div><p>Por ejemplo, un objeto de \(1 \, \text{kg}\) tiene un peso de aproximadamente \(9.807 \, \text{N}\) en la superficie terrestre.</p></div></div>
                <div class="theory-content" id="pascal-content"><div class="theory-item"><h3>Pascal (Pa)</h3><p>El pascal es la unidad de presión del SI. Representa la presión ejercida por una fuerza de 1 newton aplicada perpendicularmente sobre una superficie de 1 metro cuadrado.</p><div class="formula">\[ P = \frac{F}{A} \quad \rightarrow \quad 1 \, \text{Pa} = \frac{1 \, \text{N}}{1 \, \text{m}^2} \]</div></div></div>
                <div class="theory-content" id="joule-content"><div class="theory-item"><h3>Joule (J)</h3><p>El joule (julio) es la unidad de energía, trabajo y calor del SI. Se define como el trabajo realizado cuando una fuerza de 1 newton desplaza un objeto 1 metro.</p><div class="formula">\[ W = F \cdot d \quad \rightarrow \quad 1 \, \text{J} = 1 \, \text{N} \cdot \text{m} \]</div></div></div>
                <div class="theory-content" id="densidad-content"><div class="theory-item"><h3>Densidad (\(\rho\))</h3><p>Es la relación entre la masa de una sustancia y el volumen que ocupa.</p><div class="formula">\[ \rho = \frac{m}{V} \]</div><p>La densidad del agua a 4°C es de aproximadamente \(1000 \, \text{kg/m}^3\) o \(1 \, \text{g/cm}^3\).</p></div></div>
                <div class="theory-content" id="volumen-capacidad-content"><div class="theory-item"><h3>Volumen y Capacidad</h3><p>El volumen es el espacio tridimensional que ocupa un cuerpo, mientras que la capacidad es el volumen que puede contener un recipiente. Sus equivalencias clave son:</p><ul style="list-style-type: none; padding-left: 0;"><li>\(\quad 1 \, \text{L} = 1 \, \text{dm}^3 = 1,000 \, \text{cm}^3\)</li><li>\(\quad 1 \, \text{mL} = 1 \, \text{cm}^3\)</li><li>\(\quad 1 \, \text{m}^3 = 1,000 \, \text{L}\)</li></ul></div></div>
                <div class="theory-content" id="peso-especifico-content"><div class="theory-item"><h3>Peso Específico (\(\gamma\))</h3><p>El peso específico es la relación entre el peso de una sustancia y el volumen que ocupa. Se diferencia de la densidad en que considera el peso en lugar de la masa.</p><div class="formula">\[ \gamma = \frac{P}{V} = \rho \cdot g \]</div><p>Donde \(P\) es el peso, \(V\) es el volumen, \(\rho\) es la densidad y \(g\) es la aceleración debida a la gravedad estándar (\(9.80665 \, \text{m/s}^2\)).</p><p>En el SI, el peso específico se mide en \(\text{N/m}^3\).</p></div></div>
            </div>
        </main>
        <footer><p>Recurso educativo por Santiago Fiore. Contenido en <a href="https://sites.google.com/view/santiago-fiore/portada" target="_blank" rel="noopener noreferrer">mi sitio web</a>.</p></footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        'use strict';
        // Definición de unidades con factores de conversión precisos
        const units = {
            presion: [ {name:"Pascal",symbol:"Pa",factor:1}, {name:"Hectopascal", symbol:"hPa", factor: 100}, {name:"KiloPascal",symbol:"kPa",factor:1e3}, {name:"Bar",symbol:"bar",factor:1e5}, {name:"Atmósfera estándar",symbol:"atm",factor:101325}, {name:"PSI (libra/pulgada²)",symbol:"psi",factor:6894.75729316836}, {name:"Torr (mmHg)",symbol:"Torr",factor:133.322387415}, {name:"Kilogramo-fuerza/m²", symbol:"kgf/m²", factor: 9.80665}, {name:"Kilogramo-fuerza/cm²", symbol:"kgf/cm²", factor: 98066.5}, ],
            temperatura: [ {name:"Celsius",symbol:"°C",toBase:v=>v+273.15,fromBase:v=>v-273.15}, {name:"Fahrenheit",symbol:"°F",toBase:v=>(v-32)*5/9+273.15,fromBase:v=>(v-273.15)*9/5+32}, {name:"Kelvin",symbol:"K",toBase:v=>v,fromBase:v=>v} ],
            longitud: [ {name:"Ángstrom",symbol:"Å",factor:1e-10}, {name:"Nanómetro",symbol:"nm",factor:1e-9}, {name:"Micrómetro",symbol:"µm",factor:1e-6}, {name:"Milímetro",symbol:"mm",factor:1e-3}, {name:"Centímetro",symbol:"cm",factor:1e-2}, {name:"Decímetro",symbol:"dm",factor:1e-1}, {name:"Metro",symbol:"m",factor:1}, {name:"Decámetro",symbol:"dam",factor:1e1}, {name:"Hectómetro",symbol:"hm",factor:1e2}, {name:"Kilómetro",symbol:"km",factor:1e3}, {name:"Pulgada",symbol:"in",factor:0.0254}, {name:"Pie",symbol:"ft",factor:0.3048}, {name:"Yarda",symbol:"yd",factor:0.9144}, {name:"Milla",symbol:"mi",factor:1609.344}, {name:"Año luz",symbol:"ly",factor:9.4607304725808e15} ],
            area: [ {name:"Milímetro cuadrado",symbol:"mm²",factor:1e-6}, {name:"Centímetro cuadrado",symbol:"cm²",factor:1e-4}, {name:"Decímetro cuadrado",symbol:"dm²",factor:1e-2}, {name:"Metro cuadrado",symbol:"m²",factor:1}, {name:"Área",symbol:"a",factor:1e2}, {name:"Hectárea",symbol:"ha",factor:1e4}, {name:"Kilómetro cuadrado",symbol:"km²",factor:1e6}, {name:"Pulgada cuadrada",symbol:"in²",factor:6.4516e-4}, {name:"Pie cuadrado",symbol:"ft²",factor:9.2903e-2}, {name:"Yarda cuadrada",symbol:"yd²",factor:0.836127}, {name:"Acre",symbol:"acre",factor:4046.86} ],
            volumen: [ {name:"Milímetro cúbico",symbol:"mm³",factor:1e-9}, {name:"Centímetro cúbico",symbol:"cm³",factor:1e-6}, {name:"Decímetro cúbico",symbol:"dm³",factor:1e-3}, {name:"Metro cúbico",symbol:"m³",factor:1}, {name:"Mililitro",symbol:"mL",factor:1e-6}, {name:"Litro",symbol:"L",factor:1e-3}, {name:"Pulgada cúbica",symbol:"in³",factor:1.6387e-5}, {name:"Pie cúbico",symbol:"ft³",factor:0.0283168}, {name:"Galón (US)",symbol:"gal",factor:0.00378541} ],
            masa: [ {name:"Miligramo",symbol:"mg",factor:1e-6}, {name:"Centigramo",symbol:"cg",factor:1e-5}, {name:"Decigramo",symbol:"dg",factor:1e-4}, {name:"Gramo",symbol:"g",factor:1e-3}, {name:"Decagramo",symbol:"dag",factor:1e-2}, {name:"Hectogramo",symbol:"hg",factor:1e-1}, {name:"Kilogramo",symbol:"kg",factor:1}, {name:"Tonelada métrica",symbol:"t",factor:1e3}, {name:"Onza",symbol:"oz",factor:0.0283495}, {name:"Libra",symbol:"lb",factor:0.45359237} ],
            tiempo: [ {name:"Milisegundo",symbol:"ms",factor:1e-3}, {name:"Segundo",symbol:"s",factor:1}, {name:"Minuto",symbol:"min",factor:60}, {name:"Hora",symbol:"h",factor:3600}, {name:"Día",symbol:"d",factor:86400}, {name:"Semana",symbol:"semana",factor:604800}, {name:"Mes (30 días)",symbol:"mes",factor:2592000}, {name:"Año (365 días)",symbol:"año",factor:31536000} ],
            velocidad: [ {name:"Metro por segundo",symbol:"m/s",factor:1}, {name:"Kilómetro por hora",symbol:"km/h",factor:1/3.6}, {name:"Milla por hora",symbol:"mph",factor:0.44704}, {name:"Nudo",symbol:"knot",factor:0.514444}, {name:"Pie por segundo",symbol:"ft/s",factor:0.3048} ],
            aceleracion: [ {name:"Metro por segundo²",symbol:"m/s²",factor:1}, {name:"Aceleración de la gravedad",symbol:"g",factor:9.80665}, {name:"Pie por segundo²",symbol:"ft/s²",factor:0.3048} ],
            fuerza: [ {name:"Newton",symbol:"N",factor:1}, {name:"Kilonewton",symbol:"kN",factor:1e3}, {name:"Dina",symbol:"dyn",factor:1e-5}, {name:"Libra-fuerza",symbol:"lbf",factor:4.44822}, {name:"Kilogramo-fuerza",symbol:"kgf",factor:9.80665} ],
            densidad: [ {name:"Kilogramo por metro cúbico",symbol:"kg/m³",factor:1}, {name:"Gramo por cm cúbico",symbol:"g/cm³",factor:1e3}, {name:"Gramo por litro",symbol:"g/L",factor:1}, {name:"Libra por pie cúbico",symbol:"lb/ft³",factor:16.0185} ],
            pesoEspecifico: [ {name:"Newton por metro cúbico",symbol:"N/m³",factor:1}, {name:"Kilonewton por metro cúbico",symbol:"kN/m³",factor:1e3}, {name:"Libra-fuerza por pie cúbico",symbol:"lbf/ft³",factor:157.087} ],
            energia: [ {name:"Joule",symbol:"J",factor:1}, {name:"Kilojoule",symbol:"kJ",factor:1e3}, {name:"Caloría (term.)",symbol:"cal",factor:4.184}, {name:"Kilocaloría (kcal)",symbol:"kcal",factor:4184}, {name:"Kilovatio-hora",symbol:"kWh",factor:3.6e6}, {name:"Electronvoltio",symbol:"eV",factor:1.60218e-19} ],
            potencia: [ {name:"Vatio (Watt)",symbol:"W",factor:1}, {name:"Kilovatio",symbol:"kW",factor:1e3}, {name:"Caballo de fuerza (HP mec.)",symbol:"hp",factor:745.7}, {name:"Caballo de vapor (CV)",symbol:"CV",factor:735.499} ],
        };
        const dom = {
            category: document.getElementById('category'), fromUnit: document.getElementById('fromUnit'), toUnit: document.getElementById('toUnit'),
            value: document.getElementById('value'), convertBtn: document.getElementById('convertBtn'), resultContainer: document.getElementById('resultContainer'),
            resultValue: document.getElementById('resultValue'), steps: document.getElementById('steps'), tabs: document.querySelectorAll('.tab'),
            theoryContents: document.querySelectorAll('.theory-content'), historySection: document.getElementById('historySection'),
            historyList: document.getElementById('historyList'), clearHistoryBtn: document.getElementById('clearHistory'),
            liveRegion: document.getElementById('live-region'), valueHint: document.getElementById('valueHint'),
            swapBtn: document.getElementById('swapBtn'), errorContainer: document.getElementById('error-container'),
            toggleStepsBtn: document.getElementById('toggleStepsBtn'),
            toggleStepsContainer: document.getElementById('toggleStepsContainer'),
        };
        let conversionHistory = JSON.parse(localStorage.getItem('conversionHistory')) || [];
        
        // Cache de búsqueda de unidades para mejor performance
        let unitLookupCache = {};
        let baseUnitCache = {};
        
        // Pre-ordenar unidades una sola vez e identificar unidades base
        Object.keys(units).forEach(category => {
            units[category].sort((a, b) => a.name.localeCompare(b.name));
            // Cachear unidad base (factor = 1) para cada categoría
            const baseUnit = units[category].find(u => u.factor === 1);
            if (baseUnit) {
                baseUnitCache[category] = baseUnit;
            }
        });

        function init() {
            loadUnitsForCategory();
            setupEventListeners();
            updateValueInputRestrictions();
            if (conversionHistory.length > 0) {
                updateHistoryDisplay();
            }
        }

        function setupEventListeners() {
            dom.category.addEventListener('change', () => { loadUnitsForCategory(); updateValueInputRestrictions(); });
            dom.tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
            dom.value.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); dom.convertBtn.click(); } });
            dom.value.addEventListener('input', validateNumericInput);
            dom.convertBtn.addEventListener('click', performConversion);
            dom.swapBtn.addEventListener('click', swapUnits);
            dom.clearHistoryBtn.addEventListener('click', clearHistory);
            dom.toggleStepsBtn.addEventListener('click', toggleStepsVisibility);
        }

        function toggleStepsVisibility(event) {
            const isHidden = dom.steps.style.display === 'none' || dom.steps.style.display === '';
            dom.steps.style.display = isHidden ? 'block' : 'none';
            event.currentTarget.textContent = isHidden ? 'Ocultar Pasos' : 'Mostrar Pasos de la Conversión';
            if(isHidden) {
                if (window.MathJax) MathJax.typesetPromise([dom.steps]);
            }
        }

        function handleTabClick(event) {
            dom.tabs.forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            dom.theoryContents.forEach(c => c.classList.remove('active'));
            const contentId = `${event.currentTarget.dataset.tab}-content`;
            document.getElementById(contentId).classList.add('active');
            if (window.MathJax) MathJax.typesetPromise();
        }

        function swapUnits() {
            const fromValue = dom.fromUnit.value;
            dom.fromUnit.value = dom.toUnit.value;
            dom.toUnit.value = fromValue;
            if (dom.resultContainer.style.display === 'block') {
                const resultText = dom.resultValue.textContent.split('=')[1].trim().split(' ')[0];
                dom.value.value = resultText.replace(/,/g, '');
                performConversion();
            }
        }

        function clearHistory() {
            conversionHistory = [];
            localStorage.removeItem('conversionHistory');
            updateHistoryDisplay();
        }

        function loadUnitsForCategory() {
            const categoryValue = dom.category.value;
            const categoryUnits = units[categoryValue];
            
            // Actualizar cache de búsqueda para la categoría actual
            unitLookupCache = {};
            categoryUnits.forEach(unit => {
                unitLookupCache[unit.symbol] = unit;
            });
            
            const createOption = u => new Option(`${u.name} (${u.symbol})`, u.symbol);
            [dom.fromUnit, dom.toUnit].forEach(select => {
                select.innerHTML = '';
                categoryUnits.forEach(u => select.add(createOption(u)));
            });
            if (categoryUnits.length > 1) dom.toUnit.selectedIndex = 1;
        }

        function updateValueInputRestrictions() {
            dom.valueHint.textContent = (dom.category.value === 'temperatura') ? 'Se permiten valores negativos' : 'Usa punto para decimales. Ej: 1.5e-3';
        }

        function validateNumericInput(event) {
            let value = event.target.value;
            // Reemplazar comas por puntos
            value = value.replace(/,/g, '.');
            // Permitir solo dígitos, punto, e/E y signo menos
            value = value.replace(/[^\d.eE-]/g, '');
            // Evitar múltiples puntos decimales
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            // Evitar múltiples 'e' en notación científica
            const eParts = value.split(/e/i);
            if (eParts.length > 2) {
                value = eParts[0] + 'e' + eParts.slice(1).join('');
            }
            // Permitir signo menos solo al inicio o después de 'e'
            value = value.replace(/(?!^)-(?!.*e.*$)/g, '');
            
            event.target.value = value;
        }

        // Formateo consistente: usar notación científica para valores muy grandes o muy pequeños
        const formatNumberForDisplay = (num) => {
             if (num === 0) return '0';
             if (Math.abs(num) >= 1e12 || (Math.abs(num) < 1e-6 && num !==0)) return num.toExponential(6);
             return new Intl.NumberFormat('en-US', { maximumFractionDigits: 8, useGrouping: true }).format(num);
        };

        const formatNumberForTex = (num) => {
            if (num === 0) return '0';
            // Usar mismo umbral que formatNumberForDisplay para consistencia
            if (Math.abs(num) >= 1e12 || (Math.abs(num) < 1e-6 && num !==0)) {
                return num.toExponential(6).replace(/e\+?/, ' \\times 10^{') + '}';
            }
            return new Intl.NumberFormat('en-US', { maximumFractionDigits: 8, useGrouping: false }).format(num);
        };
        
        const formatSymbolForTex = (s) => {
            let temp_s = s.replace(/°/g, '||^{\\circ}||').replace(/²/g, '||^{2}||').replace(/³/g, '||^{3}||');
            const parts = temp_s.split('||');
            return parts.map((part, index) => {
                if (index % 2 === 0) { return part ? `\\text{${part}}` : ''; } 
                else { return part; }
            }).join('');
        };

        function performConversion() {
            clearError();
            dom.toggleStepsContainer.style.display = 'none';
            dom.resultContainer.style.display = 'none';

            const rawValue = dom.value.value.trim() || dom.value.placeholder;
            if (!rawValue) { showError('Por favor, ingresa un valor numérico.'); return; }

            const value = parseFloat(rawValue);
            if (isNaN(value) || !isFinite(value)) { showError('El valor ingresado no es un número válido.'); return; }
            
            const category = dom.category.value;
            const fromUnitSymbol = dom.fromUnit.value;
            const toUnitSymbol = dom.toUnit.value;

            if (value < 0 && category !== 'temperatura') { showError('Los valores negativos solo se permiten para temperatura.'); return; }
            if (category === 'temperatura') {
                if ((fromUnitSymbol === '°C' && value < -273.15) || (fromUnitSymbol === '°F' && value < -459.67) || (fromUnitSymbol === 'K' && value < 0)) {
                    showError('El valor no puede ser inferior al cero absoluto.'); return;
                }
            }
            if (fromUnitSymbol === toUnitSymbol) { showError('Selecciona unidades de origen y destino diferentes.'); return; }

            // Usar cache para búsqueda O(1) en vez de O(n)
            const fromUnit = unitLookupCache[fromUnitSymbol];
            const toUnit = unitLookupCache[toUnitSymbol];
            
            if (!fromUnit || !toUnit) {
                showError('Error: No se encontraron las unidades seleccionadas.');
                return;
            }
            
            // Calcular resultado con precisión limitada para evitar errores de punto flotante IEEE 754
            let result = (category === 'temperatura') ? toUnit.fromBase(fromUnit.toBase(value)) : (value * fromUnit.factor) / toUnit.factor;
            // Limitar precisión a 12 dígitos significativos para evitar errores de redondeo
            result = parseFloat(result.toPrecision(12));
            
            const texResultText = `\\[ ${formatNumberForTex(value)} \\, ${formatSymbolForTex(fromUnitSymbol)} = ${formatNumberForTex(result)} \\, ${formatSymbolForTex(toUnitSymbol)} \\]`;
            dom.resultValue.innerHTML = texResultText;
            dom.liveRegion.textContent = `Resultado: ${value} ${fromUnitSymbol} es igual a ${result} ${toUnitSymbol}`;
            
            showConversionSteps(value, fromUnit, toUnit, category, result);
            dom.resultContainer.style.display = 'block';
            
            dom.toggleStepsContainer.style.display = 'block';
            dom.steps.style.display = 'none';
            dom.toggleStepsBtn.textContent = 'Mostrar Pasos de la Conversión';
            
            if (window.MathJax) MathJax.typesetPromise([dom.resultContainer]);
            
            addToHistory(value, fromUnitSymbol, result, toUnitSymbol);
        }

        function showConversionSteps(value, fromUnit, toUnit, category, result) {
            let stepsHtml = '<h4>Pasos de la Conversión:</h4>';
            const fromUnitTex = formatSymbolForTex(fromUnit.symbol);
            const toUnitTex = formatSymbolForTex(toUnit.symbol);
            
            stepsHtml += `<div class="step"><span class="step-number">1</span><div>Valor original: \\( ${formatNumberForTex(value)} \\, ${fromUnitTex} \\)</div></div>`;
            
            if (category === 'temperatura') {
                const baseValue = fromUnit.toBase(value);
                stepsHtml += `<div class="step"><span class="step-number">2</span><div>Convertir a Kelvin (base): \\( ${formatNumberForTex(baseValue)} \\, \\text{K} \\)</div></div>`;
                stepsHtml += `<div class="step"><span class="step-number">3</span><div>Convertir a destino: \\( ${formatNumberForTex(result)} \\, ${toUnitTex} \\)</div></div>`;
            } else {
                // Usar cache O(1) en lugar de find O(n)
                const baseUnit = baseUnitCache[category];
                if (!baseUnit) {
                    dom.steps.innerHTML = '<p>No se pudo generar los pasos.</p>'; return;
                }
                const baseUnitSymbol = formatSymbolForTex(baseUnit.symbol);
                const baseValue = value * fromUnit.factor;
                stepsHtml += `<div class="step"><span class="step-number">2</span><div>A unidad base (\\(${baseUnitSymbol}\\)):<br>\\(${formatNumberForTex(value)} \\, ${fromUnitTex} \\times ${fromUnit.factor} = ${formatNumberForTex(baseValue)} \\, ${baseUnitSymbol}\\)</div></div>`;
                stepsHtml += `<div class="step"><span class="step-number">3</span><div>A unidad destino (\\(${toUnitTex}\\)):<br>\\(${formatNumberForTex(baseValue)} \\, ${baseUnitSymbol} \\div ${toUnit.factor} = ${formatNumberForTex(result)} \\, ${toUnitTex}\\)</div></div>`;
            }
            stepsHtml += `<div class="step" style="background-color: #e8f5e9; font-weight: bold;"><span class="step-number" style="background-color: var(--success-color);">✔</span>Resultado Final: \\( ${formatNumberForTex(result)} \\, ${toUnitTex} \\)</div>`;
            dom.steps.innerHTML = stepsHtml;
        }

        function addToHistory(value, fromUnit, result, toUnit) {
            const MAX_HISTORY_ITEMS = 10;
            const newEntry = { value, fromUnit, result, toUnit, timestamp: new Date().toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' }) };
            conversionHistory.unshift(newEntry);
            if (conversionHistory.length > MAX_HISTORY_ITEMS) conversionHistory.pop();
            localStorage.setItem('conversionHistory', JSON.stringify(conversionHistory));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            if (conversionHistory.length === 0) {
                 dom.historySection.style.display = 'none';
                 return;
            }
            dom.historyList.innerHTML = conversionHistory.map(c => `
                <div class="history-item">
                    <span>${formatNumberForDisplay(c.value)} ${c.fromUnit} → ${formatNumberForDisplay(c.result)} ${c.toUnit}</span>
                    <span class="history-item-date">${c.timestamp}</span>
                </div>`).join('');
            dom.historySection.style.display = 'block';
        }
        
        function showError(message) {
            clearError();
            dom.resultContainer.style.display = 'none';
            dom.toggleStepsContainer.style.display = 'none';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.setAttribute('role', 'alert');
            dom.errorContainer.appendChild(errorDiv);
            dom.liveRegion.textContent = `Error: ${message}`;
        }
        const clearError = () => { dom.errorContainer.innerHTML = ''; };

        init();
    });
    </script>
</body>
</html>